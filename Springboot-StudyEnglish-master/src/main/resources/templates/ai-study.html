<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AI学习中心 - Let's study English !</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
    <link rel="stylesheet" th:href="@{/static/css/cs-skin-elastic.css}">
    <link rel="stylesheet" th:href="@{/static/css/style.css}">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">

</head>

<body>

<!-- Left Panel -->
<div th:replace="common/leftbar::leftbar"/>

<!-- Right Panel -->
<div id="right-panel" class="right-panel">
    <!-- Header-->
    <div th:replace="common/header::header"/>
    <!-- /#header -->
    <!-- Content -->
    <div class="content">
        <!-- Animated -->
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="box-title">AI学习中心</h2>
                            <p class="text-muted">使用AI助手提升您的英语学习效果</p>
                        </div>
                        <div class="card-body">
                            
                            <!-- 选项卡导航 -->
                            <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="vocab-tab" data-toggle="tab" href="#vocab" role="tab" aria-controls="vocab" aria-selected="true">词汇详解</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="sentence-tab" data-toggle="tab" href="#sentence" role="tab" aria-controls="sentence" aria-selected="false">长难句解析</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="essay-tab" data-toggle="tab" href="#essay" role="tab" aria-controls="essay" aria-selected="false">作文批改</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="translation-tab" data-toggle="tab" href="#translation" role="tab" aria-controls="translation" aria-selected="false">翻译练习</a>
                                </li>
                            </ul>
                            
                            <!-- 选项卡内容 -->
                            <div class="tab-content mt-4" id="aiTabsContent">
                                
                                <!-- 词汇详解 -->
                                <div class="tab-pane fade show active" id="vocab" role="tabpanel" aria-labelledby="vocab-tab">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>词汇详解</h4>
                                                    <p>输入单词，获取AI生成的详细解释、搭配、例句等</p>
                                                    <form id="vocabForm">
                                                        <div class="form-group">
                                                            <label for="vocabWord">单词</label>
                                                            <input type="text" class="form-control" id="vocabWord" name="word" placeholder="请输入要查询的单词" required>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">生成详解</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>AI生成结果</h4>
                                                    <div id="vocabResult" style="min-height: 200px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                                        <div class="text-center text-muted">请输入单词并点击生成详解</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 长难句解析 -->
                                <div class="tab-pane fade" id="sentence" role="tabpanel" aria-labelledby="sentence-tab">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>长难句解析</h4>
                                                    <p>输入长难句，获取AI生成的语法结构分析、成分划分、翻译等</p>
                                                    <form id="sentenceForm">
                                                        <div class="form-group">
                                                            <label for="sentenceText">长难句</label>
                                                            <textarea class="form-control" id="sentenceText" name="sentence" rows="5" placeholder="请输入要解析的长难句" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">解析句子</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>AI生成结果</h4>
                                                    <div id="sentenceResult" style="min-height: 200px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                                        <div class="text-center text-muted">请输入长难句并点击解析句子</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 作文批改 -->
                                <div class="tab-pane fade" id="essay" role="tabpanel" aria-labelledby="essay-tab">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>作文批改</h4>
                                                    <p>输入作文，获取AI生成的评分、修改建议、亮点分析等</p>
                                                    <form id="essayForm">
                                                        <div class="form-group">
                                                            <label for="essayText">作文内容</label>
                                                            <textarea class="form-control" id="essayText" name="essay" rows="8" placeholder="请输入作文内容" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">批改作文</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>AI生成结果</h4>
                                                    <div id="essayResult" style="min-height: 200px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                                        <div class="text-center text-muted">请输入作文并点击批改作文</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 翻译练习 -->
                                <div class="tab-pane fade" id="translation" role="tabpanel" aria-labelledby="translation-tab">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>翻译练习</h4>
                                                    <p>输入中文文本，获取AI生成的英文翻译和相关知识点</p>
                                                    <form id="translationForm">
                                                        <div class="form-group">
                                                            <label for="translationText">中文文本</label>
                                                            <textarea class="form-control" id="translationText" name="chineseText" rows="5" placeholder="请输入要翻译的中文文本" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">生成翻译</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>AI生成结果</h4>
                                                    <div id="translationResult" style="min-height: 200px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                                        <div class="text-center text-muted">请输入中文文本并点击生成翻译</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content -->
    <div class="clearfix"></div>
    <!-- Footer -->
    <div th:replace="common/footer::footer"/>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
<script th:src="@{/static/js/main.js}"></script>

<script>
// 通用的表单提交处理函数
function handleFormSubmit(formId, endpoint, resultId) {
    document.getElementById(formId).addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const resultDiv = document.getElementById(resultId);
        const btn = form.querySelector('button[type="submit"]');
        
        // 显示加载状态
        const originalBtnText = btn.innerHTML;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
        btn.disabled = true;
        resultDiv.innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin"></i> 正在生成AI结果...</div>';
        
        // 获取表单数据
        const formData = new FormData(form);
        const urlEncodedData = new URLSearchParams(formData).toString();
        
        // 调用AI接口
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: urlEncodedData
        })
        .then(response => response.text())
        .then(data => {
            try {
                const result = JSON.parse(data);
                // 优先检查错误信息
                if (result.error) {
                    resultDiv.innerHTML = '<div class="text-danger">错误：' + result.error + '</div>';
                    return;
                }
                // 检查 OpenAI 格式的响应
                if (result.choices && result.choices.length > 0 && result.choices[0].message) {
                    const content = result.choices[0].message.content;
                    resultDiv.innerHTML = '<div style="white-space: pre-wrap;">' + content + '</div>';
                } else {
                    // 如果没有标准格式，显示原始响应以便调试
                    console.error('响应格式异常:', result);
                    resultDiv.innerHTML = '<div class="text-danger">生成结果格式异常<br><small>请查看控制台了解详情</small></div>';
                }
            } catch (e) {
                // JSON解析失败，可能是纯文本响应
                console.error('JSON解析失败:', e, '原始数据:', data);
                if (data.includes('error')) {
                    resultDiv.innerHTML = '<div class="text-danger">' + data + '</div>';
                } else {
                    resultDiv.innerHTML = '<div style="white-space: pre-wrap;">' + data + '</div>';
                }
            }
        })
        .catch(error => {
            console.error('请求失败:', error);
            resultDiv.innerHTML = '<div class="text-danger">生成失败，请重试<br><small>' + error.message + '</small></div>';
        })
        .finally(() => {
            // 恢复按钮状态
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
        });
    });
}

// 初始化各个表单的事件监听
handleFormSubmit('vocabForm', '/cet6/vocab/explanation', 'vocabResult');
handleFormSubmit('sentenceForm', '/cet6/sentence/parse', 'sentenceResult');
handleFormSubmit('essayForm', '/cet6/essay/correct', 'essayResult');
handleFormSubmit('translationForm', '/cet6/translation/generate', 'translationResult');
</script>

</body>
</html>
